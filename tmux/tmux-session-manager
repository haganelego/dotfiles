#!/usr/bin/env zsh

# アイコン選択関数
select_icon() {
  selected=$(
    cat <<'EOF' | fzf --prompt="Icon: " --preview-window=hidden
 : default
󱄅 : nix
 : paw
 : key
 : fan
 : cut
 : setting
 : bug
 : db
 : tag
 : sun
 : pin
 : script
󰐟 : poll
󰇥 : duck
󱗆 : bird
 : wind
 : tree
 : tint
 : tool
 : suse
 : save
 : plug
 : mask
 : leaf
 : home
 : gift
 : frog
 : fish
 : bone
 : neovim
󰢱 : lua
 : cpp
 : typescript
 : pen
EOF
  )

  if [ -n "$selected" ]; then
    echo "$selected" | awk '{print $1}'
  else
    # キャンセルされた場合はデフォルト
    echo ""
  fi
}

# セッション一覧を整形してソート
sessions=$(tmux list-sessions -F '#{session_name}' 2>/dev/null | while read -r s; do
  if [ "$(echo "$s" | cut -c2)" = " " ]; then
    echo "$(echo "$s" | cut -c3-)|$s"
  else
    echo "$s|$s"
  fi
done | sort | cut -d'|' -f2)

# tmuxセッション一覧をfzfで表示
result=$(echo "$sessions" |
  fzf --prompt="Session: " \
    --preview='tmux list-windows -t {} -F "#{window_index}: #{window_name}"' \
    --preview-window=right:20% \
    --expect=ctrl-q,ctrl-t,ctrl-r \
    --no-select-1 \
    --header='Enter: switch/attach | ^Q: kill | ^T: new | ^R: rename')

if [ -z "$result" ]; then
  exit 0
fi

key=$(echo "$result" | sed -n '1p')
session=$(echo "$result" | sed -n '2p')

# セッションにアタッチまたは切り替える共通関数
switch_or_attach() {
  local target=$1
  if [ -z "$TMUX" ]; then
    # tmuxの外にいる場合
    tmux attach-session -t "$target"
  else
    # tmuxの中にいる場合
    tmux switch-client -t "$target"
  fi
}

case "$key" in
ctrl-q)
  if [ -n "$session" ]; then
    echo -n "Kill session '$session'? (y/N): "
    read -r answer
    if [[ "$answer" =~ ^[yY]$ ]]; then
      # tmux内にいる場合のみカレントセッションかチェック
      if [ -n "$TMUX" ]; then
        current_session=$(tmux display-message -p '#S')
        if [ "$session" = "$current_session" ]; then
          tmux switch-client -n
        fi
      fi
      tmux kill-session -t "$session"
      echo "Session '$session' killed."
    else
      echo "Cancelled."
    fi
  fi
  ;;

ctrl-t)
  echo -n "New session name: "
  read -r new_session
  if [ -n "$new_session" ]; then
    icon=$(select_icon)
    full_session_name="$icon $new_session"
    tmux new-session -d -s "$full_session_name"
    switch_or_attach "$full_session_name"
  else
    echo "Cancelled."
  fi
  ;;

ctrl-r)
  if [ -n "$session" ]; then
    echo -n "New name for '$session': "
    read -r new_name
    if [ -n "$new_name" ]; then
      icon=$(select_icon)
      full_session_name="$icon $new_name"
      tmux rename-session -t "$session" "$full_session_name"
      echo "Session renamed to '$full_session_name'."
    else
      echo "Cancelled."
    fi
  fi
  ;;

*)
  if [ -n "$session" ]; then
    switch_or_attach "$session"
  fi
  ;;
esac
